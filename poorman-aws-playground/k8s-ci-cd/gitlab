resource "kubernetes_namespace" "gitlab" {
  metadata {
    name = "gitlab"
  }
}

resource "aws_route53_record" "gitlab" {
  name     = "gitlab.${var.route53_private_zone}"
  type     = "CNAME"
  ttl      = "300"
  records  = [data.terraform_remote_state.k8s_core_apps.outputs.nginx_ingress_controller_fqdn]
  zone_id  = data.aws_route53_zone.route53_private_zone.zone_id
}

resource "helm_release" "gitlab" {
  name       = "gitlab"
  chart      = "gitlab"
  repository = "https://charts.gitlab.io/"
  version    = "9.0.0"
  namespace  = kubernetes_namespace.gitlab.metadata[0].name
  values = [
    templatefile("gitlab-values.tpl.yaml", {
        domain      = var.route53_private_zone
        gitlab_name = aws_route53_record.gitlab.fqdn
    })
  ]
}

# kubectl -n gitlab get secret gitlab-gitlab-initial-root-password -ojsonpath='{.data.password}' | base64 --decode ; echo
# git clone ssh://git@gitlab.lesposito87.intra:30022/lesposito/testone.git
